# ~/.zshrc - managed by chezmoi
# vim: set ft=zsh:

# =============================================================================
# Oh-My-Zsh Configuration
# =============================================================================
{{- if (index . "installZsh" | default false) }}

export ZSH="$HOME/.oh-my-zsh"

# Theme
ZSH_THEME="robbyrussell"

# Plugins
plugins=(
    git
    docker
    docker-compose
    kubectl
    zsh-autosuggestions
    zsh-syntax-highlighting
    zsh-completions
)

# Load oh-my-zsh
[[ -f "$ZSH/oh-my-zsh.sh" ]] && source "$ZSH/oh-my-zsh.sh"
{{- end }}

# =============================================================================
# Environment Variables
# =============================================================================

export EDITOR="{{ index . "editor" | default "vim" }}"
export VISUAL="{{ index . "editor" | default "vim" }}"
export LANG="en_US.UTF-8"
export LC_ALL="en_US.UTF-8"

# XDG Base Directory
export XDG_CONFIG_HOME="$HOME/.config"
export XDG_DATA_HOME="$HOME/.local/share"
export XDG_CACHE_HOME="$HOME/.cache"

# Local bin
export PATH="$HOME/.local/bin:$PATH"

# =============================================================================
# Platform-Specific Configuration
# =============================================================================
{{- if eq .chezmoi.os "darwin" }}

# Homebrew
if [[ -f /opt/homebrew/bin/brew ]]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
elif [[ -f /usr/local/bin/brew ]]; then
    eval "$(/usr/local/bin/brew shellenv)"
fi
{{- end }}

# =============================================================================
# Tool Initialization
# =============================================================================
{{- if (index . "installPython" | default false) }}

# pyenv
export PYENV_ROOT="$HOME/.pyenv"
[[ -d "$PYENV_ROOT/bin" ]] && export PATH="$PYENV_ROOT/bin:$PATH"
if command -v pyenv &>/dev/null; then
    eval "$(pyenv init --path)"
    eval "$(pyenv init -)"
fi
{{- end }}

{{- if (index . "installNode" | default false) }}

# fnm (Fast Node Manager)
export PATH="$HOME/.local/share/fnm:$PATH"
if command -v fnm &>/dev/null; then
    eval "$(fnm env --use-on-cd)"
fi
{{- end }}

{{- if (index . "installDirenv" | default false) }}

# direnv
if command -v direnv &>/dev/null; then
    eval "$(direnv hook zsh)"
fi
{{- end }}

# =============================================================================
# CLI Tool Configuration
# =============================================================================
{{- if (index . "installCliTools" | default false) }}

# fzf
if command -v fzf &>/dev/null; then
    # Use fd for fzf if available
    if command -v fd &>/dev/null; then
        export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
        export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
        export FZF_ALT_C_COMMAND='fd --type d --hidden --follow --exclude .git'
    fi
    
    # fzf key bindings and completion
    {{- if eq .chezmoi.os "darwin" }}
    [[ -f ~/.fzf.zsh ]] && source ~/.fzf.zsh
    {{- else }}
    [[ -f /usr/share/doc/fzf/examples/key-bindings.zsh ]] && source /usr/share/doc/fzf/examples/key-bindings.zsh
    [[ -f /usr/share/doc/fzf/examples/completion.zsh ]] && source /usr/share/doc/fzf/examples/completion.zsh
    {{- end }}
fi

# bat (better cat)
if command -v bat &>/dev/null; then
    alias cat='bat --paging=never'
    export BAT_THEME="Dracula"
fi

# eza (better ls)
if command -v eza &>/dev/null; then
    alias ls='eza'
    alias ll='eza -la --git'
    alias la='eza -a'
    alias lt='eza --tree --level=2'
else
    alias ll='ls -la'
    alias la='ls -A'
fi
{{- end }}

# =============================================================================
# Aliases
# =============================================================================

# Git shortcuts (if not using oh-my-zsh git plugin)
alias g='git'
alias gs='git status'
alias gd='git diff'
alias gc='git commit'
alias gp='git push'
alias gl='git pull'

# Navigation
alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'

# Safety nets
alias rm='rm -i'
alias cp='cp -i'
alias mv='mv -i'

# Misc
alias c='clear'
alias h='history'
alias j='jobs -l'

{{- if (index . "installNeovim" | default false) }}
alias vim='nvim'
alias vi='nvim'
{{- end }}

# =============================================================================
# Functions
# =============================================================================

# Create directory and cd into it
mkcd() {
    mkdir -p "$1" && cd "$1"
}

# Extract various archive formats
extract() {
    if [[ -f "$1" ]]; then
        case "$1" in
            *.tar.bz2) tar xjf "$1" ;;
            *.tar.gz)  tar xzf "$1" ;;
            *.bz2)     bunzip2 "$1" ;;
            *.rar)     unrar x "$1" ;;
            *.gz)      gunzip "$1" ;;
            *.tar)     tar xf "$1" ;;
            *.tbz2)    tar xjf "$1" ;;
            *.tgz)     tar xzf "$1" ;;
            *.zip)     unzip "$1" ;;
            *.Z)       uncompress "$1" ;;
            *.7z)      7z x "$1" ;;
            *)         echo "'$1' cannot be extracted via extract()" ;;
        esac
    else
        echo "'$1' is not a valid file"
    fi
}

# =============================================================================
# History Configuration
# =============================================================================

HISTSIZE=50000
SAVEHIST=50000
HISTFILE="$HOME/.zsh_history"

setopt HIST_IGNORE_DUPS
setopt HIST_IGNORE_SPACE
setopt HIST_FIND_NO_DUPS
setopt SHARE_HISTORY
setopt EXTENDED_HISTORY

# =============================================================================
# Local Configuration
# =============================================================================

# Source local overrides if present
[[ -f "$HOME/.zshrc.local" ]] && source "$HOME/.zshrc.local"
