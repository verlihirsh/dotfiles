# ~/.zshrc - managed by chezmoi
# vim: set ft=zsh:

# =============================================================================
# Source common shell config from .bashrc
# =============================================================================

[[ -f "$HOME/.bashrc" ]] && source "$HOME/.bashrc"

# =============================================================================
# Oh-My-Zsh Configuration
# =============================================================================
{{- if (index . "installZsh" | default false) }}

export ZSH="$HOME/.oh-my-zsh"

# Theme (disabled when using Starship)
{{- if (index . "installStarship" | default false) }}
ZSH_THEME=""
{{- else }}
ZSH_THEME="robbyrussell"
{{- end }}

# Plugins
plugins=(
    git
    docker
    docker-compose
    kubectl
    fzf-tab
    fzf-tab-source
    zsh-autosuggestions
    zsh-syntax-highlighting
    zsh-completions
    zsh-history-substring-search
)

# Load oh-my-zsh
[[ -f "$ZSH/oh-my-zsh.sh" ]] && source "$ZSH/oh-my-zsh.sh"
{{- end }}

# =============================================================================
# Zsh-specific Configuration
# =============================================================================

# History
HISTSIZE=50000
SAVEHIST=50000
HISTFILE="$HOME/.zsh_history"

setopt HIST_IGNORE_DUPS
setopt HIST_IGNORE_SPACE
setopt HIST_FIND_NO_DUPS
setopt SHARE_HISTORY
setopt EXTENDED_HISTORY

# Auto cd - type directory name to cd into it (no cd command needed)
setopt AUTO_CD

# Tab completion
autoload -Uz compinit && compinit

# Use emacs keybindings (standard terminal behavior)
bindkey -e

# History substring search keybindings
bindkey "^[[A" history-substring-search-up   # Up arrow
bindkey "^[[B" history-substring-search-down # Down arrow

zstyle ':completion:*' menu select
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}'
zstyle ':completion:*:descriptions' format '[%d]'


wttr() {
  local ttl=600  # seconds (10 min)
  local cache_dir="${XDG_CACHE_HOME:-$HOME/.cache}/wttr"
  local cache_file="$cache_dir/wttr.txt"

  mkdir -p "$cache_dir"

  local now mtime age
  now=$(date +%s)

  if [[ -f "$cache_file" ]]; then
    mtime=$(stat -f %m "$cache_file")
    age=$(( now - mtime ))
  else
    age=$(( ttl + 1 ))
  fi

  if (( age < ttl )); then
    cat "$cache_file"
  else
    curl -fsS 'wttr.in/{Alicante,Reikiavik,Krasnoyarsk}?format=%l:+%c+%t+|+%f+|+%w+(%p)\n' \
      | tee "$cache_file"
  fi
}


# =============================================================================
# Plugin Configuration
# =============================================================================

# FZF-tab configuration
zstyle ':fzf-tab:*' ftb-tmux-popup
zstyle ':fzf-tab:*' popup-pad 30 0
# Fixed popup size: 80% width, 30 lines height (doesn't shrink with content)
zstyle ':fzf-tab:*' popup-min-size 80 30
zstyle ':fzf-tab:*' fzf-min-height 30
zstyle ':fzf-tab:*' show-group full

# Autosuggestions strategy
ZSH_AUTOSUGGEST_STRATEGY=(history completion)

# Zoxide (smart cd)
{{- if (index . "$hasZoxide" | default false) }}
if command -v zoxide &>/dev/null; then
    eval "$(zoxide init zsh)"
fi
{{- end}}


{{- if (index . "$hasAsdf" | default false) }}
  export PATH="${ASDF_DATA_DIR:-$HOME/.asdf}/shims:$PATH"
{{- end }}

# =============================================================================
# Local Configuration
# =============================================================================

# Source local overrides if present
[[ -f "$HOME/.zshrc.local" ]] && source "$HOME/.zshrc.local"

# OpenCode stats widget (current month)
{{- if (index . "installOpencode" | default false) }}
alias ocstats="~/.config/ocstats.sh"
alias ocwatch="watch -t -n 60 --color ~/.config/ocstats.sh"
{{- end }}
