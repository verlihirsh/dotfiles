# ~/.bashrc - managed by chezmoi
# Common shell configuration (sourced by both bash and zsh)

# =============================================================================
# Environment Variables
# =============================================================================

export EDITOR="{{ index . "editor" | default "vim" }}"
export VISUAL="{{ index . "editor" | default "vim" }}"
export LANG="en_US.UTF-8"
export LC_ALL="en_US.UTF-8"

# XDG Base Directory
export XDG_CONFIG_HOME="$HOME/.config"
export XDG_DATA_HOME="$HOME/.local/share"
export XDG_CACHE_HOME="$HOME/.cache"

# Local bin
export PATH="$HOME/.local/bin:$PATH"

# =============================================================================
# Platform-Specific Configuration
# =============================================================================
{{- if eq .chezmoi.os "darwin" }}

# Homebrew
if [[ -f /opt/homebrew/bin/brew ]]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
elif [[ -f /usr/local/bin/brew ]]; then
    eval "$(/usr/local/bin/brew shellenv)"
fi
{{- end }}

# =============================================================================
# Tool Initialization
# =============================================================================
{{- if (index . "installPython" | default false) }}

# uv - Python package and version manager
# No shell initialization needed - uv manages Python versions via .python-version files
# uv is installed to ~/.local/bin which is already in PATH (line 19)
{{- end }}

{{- if (index . "installNode" | default false) }}

# fnm (Fast Node Manager)
export PATH="$HOME/.local/share/fnm:$PATH"
if command -v fnm &>/dev/null; then
    eval "$(fnm env --use-on-cd)"
fi
{{- end }}

{{- if (index . "installDirenv" | default false) }}

# direnv
if command -v direnv &>/dev/null; then
    if [[ -n "$ZSH_VERSION" ]]; then
        eval "$(direnv hook zsh)"
    elif [[ -n "$BASH_VERSION" ]]; then
        eval "$(direnv hook bash)"
    fi
fi
{{- end }}

{{- if (index . "installOpencode" | default false) }}

# OpenCode + bun (for oh-my-opencode)
export PATH="$HOME/.opencode/bin:$HOME/.bun/bin:$PATH"
{{- end }}

# =============================================================================
# CLI Tool Configuration
# =============================================================================
{{- if (index . "installCliTools" | default false) }}

# zoxide (smart cd)
if command -v zoxide &>/dev/null; then
    if [[ -n "$ZSH_VERSION" ]]; then
        eval "$(zoxide init zsh)"
    elif [[ -n "$BASH_VERSION" ]]; then
        eval "$(zoxide init bash)"
    fi
fi

# fzf
if command -v fzf &>/dev/null; then
    # Use fd for fzf if available
    if command -v fd &>/dev/null; then
        export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
        export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
        export FZF_ALT_C_COMMAND='fd --type d --hidden --follow --exclude .git'
    fi
    
    # UI options
    FZF_PREVIEW_OPTS=""
    if command -v fzf-preview.sh &>/dev/null; then
        FZF_PREVIEW_OPTS=" --preview 'fzf-preview.sh {}'"
    fi
    export FZF_DEFAULT_OPTS=" \
        --style=full \
        --tmux=center,80%,60% \
        --bind 'focus:transform-header:file'${FZF_PREVIEW_OPTS}"
    
    # fzf key bindings and completion
    {{- if eq .chezmoi.os "darwin" }}
    if [[ -n "$ZSH_VERSION" ]]; then
        [[ -f ~/.fzf.zsh ]] && source ~/.fzf.zsh
    else
        [[ -f ~/.fzf.bash ]] && source ~/.fzf.bash
    fi
    {{- else }}
    if [[ -n "$ZSH_VERSION" ]]; then
        [[ -f /usr/share/doc/fzf/examples/key-bindings.zsh ]] && source /usr/share/doc/fzf/examples/key-bindings.zsh
        [[ -f /usr/share/doc/fzf/examples/completion.zsh ]] && source /usr/share/doc/fzf/examples/completion.zsh
    else
        [[ -f /usr/share/doc/fzf/examples/key-bindings.bash ]] && source /usr/share/doc/fzf/examples/key-bindings.bash
        [[ -f /usr/share/doc/fzf/examples/completion.bash ]] && source /usr/share/doc/fzf/examples/completion.bash
    fi
    {{- end }}
fi

# bat (better cat)
if command -v bat &>/dev/null; then
    alias cat='bat --paging=never'
    export BAT_THEME="Dracula"
fi

# eza (better ls)
if command -v eza &>/dev/null; then
    alias ls='eza'
    alias ll='eza -la --git'
    alias la='eza -a'
    alias lt='eza --tree --level=2'
else
    alias ll='ls -la'
    alias la='ls -A'
fi
{{- end }}

# =============================================================================
# Aliases
# =============================================================================

# Git shortcuts
alias g='git'
alias gs='git status'
alias gd='git diff'
alias gc='git commit'
alias gcam='git commit -am $1'
alias gp='git push'
alias gpsup='git push -u origin'
alias gl='git pull'
alias ggl='git pull'

# Safety nets
alias rm='rm -i'
alias cp='cp -i'
alias mv='mv -i'

# Misc
alias c='clear'
alias h='history'
alias j='jobs -l'

{{- if (index . "installNeovim" | default false) }}
alias vim='nvim'
alias vi='nvim'
{{- end }}

# =============================================================================
# Functions
# =============================================================================

# Create directory and cd into it
mkcd() {
    mkdir -p "$1" && cd "$1"
}

# AI-assisted git commit
gcama() {
    git add .
    local commit_msg=$(opencode run --model github-copilot/claude-haiku-4.5 --format json "Check git diff and return commit message for this diff" | jq -r 'select(.type == "text") | .text' | tail -n 1)
    gcam "$commit_msg"
}

# Extract various archive formats
extract() {
    if [[ -f "$1" ]]; then
        case "$1" in
            *.tar.bz2) tar xjf "$1" ;;
            *.tar.gz)  tar xzf "$1" ;;
            *.bz2)     bunzip2 "$1" ;;
            *.rar)     unrar x "$1" ;;
            *.gz)      gunzip "$1" ;;
            *.tar)     tar xf "$1" ;;
            *.tbz2)    tar xjf "$1" ;;
            *.tgz)     tar xzf "$1" ;;
            *.zip)     unzip "$1" ;;
            *.Z)       uncompress "$1" ;;
            *.7z)      7z x "$1" ;;
            *)         echo "'$1' cannot be extracted via extract()" ;;
        esac
    else
        echo "'$1' is not a valid file"
    fi
}

{{- if (index . "installTmux" | default false) }}

# =============================================================================
# tmux Helpers
# =============================================================================

# Session management aliases
alias ta='tmux attach-session -t'
alias tl='tmux list-sessions'
alias tn='tmux new-session -s'
alias tk='tmux kill-session -t'
alias ts='tmux switch-client -t'

# Quick session with current directory name
tcd() {
    local name="${1:-$(basename "$PWD")}"
    tmux new-session -A -s "$name"
}

# Session/window picker with fzf and preview
tpick() {
    if ! command -v tmux &>/dev/null; then
        echo "tmux not installed" >&2
        return 1
    fi
    
    if ! tmux has-session 2>/dev/null; then
        echo "No tmux sessions" >&2
        return 1
    fi
    
    local selected
    selected=$(tmux list-windows -a -F '#{session_name}:#{window_index} │ #{window_name}#{?window_active, ←,}#{?session_attached, [attached],}' | \
        fzf --prompt='tmux > ' \
            --height=40% \
            --reverse \
            --preview='tmux capture-pane -t {1} -p 2>/dev/null | head -30' \
            --preview-window=right:50%:wrap | \
        cut -d' ' -f1)
    
    if [[ -n "$selected" ]]; then
        if [[ -n "$TMUX" ]]; then
            tmux switch-client -t "$selected"
        else
            tmux attach-session -t "$selected"
        fi
    fi
}

# Create new session with picker fallback
tnew() {
    local name="${1:-}"
    if [[ -z "$name" ]]; then
        echo -n "Session name: "
        read name
    fi
    if [[ -n "$name" ]]; then
        if [[ -n "$TMUX" ]]; then
            tmux new-session -d -s "$name" && tmux switch-client -t "$name"
        else
            tmux new-session -s "$name"
        fi
    fi
}
{{- end }}

# =============================================================================
# Bash-specific Configuration
# =============================================================================

if [[ -n "$BASH_VERSION" ]]; then
    # History
    HISTSIZE=50000
    HISTFILESIZE=50000
    HISTCONTROL=ignoreboth:erasedups
    shopt -s histappend
    
    # Source local overrides if present
    [[ -f "$HOME/.bashrc.local" ]] && source "$HOME/.bashrc.local"
fi

# =============================================================================
# Prompt Configuration
# =============================================================================
{{- if (index . "installStarship" | default false) }}

# Starship prompt (must be at end of file)
if command -v starship &>/dev/null; then
    if [[ -n "$ZSH_VERSION" ]]; then
        eval "$(starship init zsh)"
    elif [[ -n "$BASH_VERSION" ]]; then
        eval "$(starship init bash)"
    fi
fi
{{- end }}
