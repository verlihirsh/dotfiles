#!/usr/bin/env bash
#
# Doctor script - verify dotfiles installation
#
# Run manually: ~/.local/bin/dotfiles-doctor
#
# Version: 1.0.0

set -euo pipefail

GREEN='\033[0;32m'
YELLOW='\033[0;33m'
RED='\033[0;31m'
NC='\033[0m'

PASS_COUNT=0
WARN_COUNT=0
FAIL_COUNT=0

pass() {
    echo -e "${GREEN}✓${NC} $1"
    ((PASS_COUNT++))
}

warn() {
    echo -e "${YELLOW}⚠${NC} $1"
    ((WARN_COUNT++))
}

fail() {
    echo -e "${RED}✗${NC} $1"
    ((FAIL_COUNT++))
}

check_command() {
    local cmd="$1"
    local name="${2:-$cmd}"
    if command -v "$cmd" &>/dev/null; then
        pass "$name installed: $(command -v "$cmd")"
        return 0
    else
        fail "$name not found"
        return 1
    fi
}

check_file() {
    local file="$1"
    local name="${2:-$file}"
    if [[ -f "$file" ]]; then
        pass "$name exists"
        return 0
    else
        fail "$name not found"
        return 1
    fi
}

check_dir() {
    local dir="$1"
    local name="${2:-$dir}"
    if [[ -d "$dir" ]]; then
        pass "$name exists"
        return 0
    else
        fail "$name not found"
        return 1
    fi
}

echo "======================================"
echo "  Dotfiles Installation Doctor"
echo "======================================"
echo ""

echo "--- Core ---"
check_command chezmoi
check_command git
check_file "$HOME/.bashrc" ".bashrc"

echo ""
echo "--- Shell ---"
if [[ -n "${ZSH_VERSION:-}" ]] || check_command zsh; then
    pass "zsh available"
    check_dir "$HOME/.oh-my-zsh" "oh-my-zsh"
    check_file "$HOME/.zshrc" ".zshrc"
else
    warn "zsh not installed (bash-only mode)"
fi

echo ""
echo "--- Prompt ---"
if check_command starship; then
    check_file "$HOME/.config/starship.toml" "starship config"
fi

echo ""
echo "--- Fonts ---"
if [[ "$(uname)" == "Darwin" ]]; then
    if ls ~/Library/Fonts/*NerdFont* &>/dev/null 2>&1 || \
       ls /Library/Fonts/*NerdFont* &>/dev/null 2>&1 || \
       fc-list 2>/dev/null | grep -qi "nerd"; then
        pass "Nerd Fonts installed"
    else
        warn "Nerd Fonts not detected (check terminal font settings)"
    fi
else
    if [[ -d "$HOME/.local/share/fonts" ]] && ls "$HOME/.local/share/fonts"/*NerdFont* &>/dev/null 2>&1; then
        pass "Nerd Fonts installed"
    elif fc-list 2>/dev/null | grep -qi "nerd"; then
        pass "Nerd Fonts installed"
    else
        warn "Nerd Fonts not detected"
    fi
fi

echo ""
echo "--- Python ---"
if check_command pyenv; then
    if pyenv versions 2>/dev/null | grep -q '[0-9]'; then
        pass "Python versions installed via pyenv"
        pyenv versions 2>/dev/null | head -3
    else
        warn "pyenv installed but no Python versions found"
    fi
fi

echo ""
echo "--- Node.js ---"
if check_command fnm; then
    if fnm list 2>/dev/null | grep -q '[0-9]'; then
        pass "Node.js versions installed via fnm"
        fnm list 2>/dev/null | head -3
    else
        warn "fnm installed but no Node versions found"
    fi
fi

echo ""
echo "--- Editor ---"
if check_command nvim "Neovim"; then
    check_dir "$HOME/.config/nvim" "Neovim config"
fi

echo ""
echo "--- CLI Tools ---"
check_command fzf || true
check_command rg "ripgrep" || true
check_command fd || true
check_command bat || true
check_command eza || true
check_command jq || true
check_command htop || true
check_command tmux || true
check_command direnv || true

echo ""
echo "--- LSP Servers ---"
check_command pyright || true
check_command typescript-language-server "tsserver" || true
check_command gopls || true
check_command lua-language-server || true
check_command bash-language-server || true
check_command yaml-language-server || true
check_command marksman || true

echo ""
echo "--- OpenCode ---"
if check_command opencode; then
    check_dir "$HOME/.config/opencode" "OpenCode config"
fi

echo ""
echo "--- Git ---"
check_file "$HOME/.gitconfig" ".gitconfig"
if git config --get user.name &>/dev/null && git config --get user.email &>/dev/null; then
    pass "Git user configured: $(git config --get user.name) <$(git config --get user.email)>"
else
    fail "Git user not configured"
fi

echo ""
echo "======================================"
echo "  Summary"
echo "======================================"
echo -e "  ${GREEN}Passed${NC}: $PASS_COUNT"
echo -e "  ${YELLOW}Warnings${NC}: $WARN_COUNT"
echo -e "  ${RED}Failed${NC}: $FAIL_COUNT"
echo "======================================"

if [[ $FAIL_COUNT -gt 0 ]]; then
    exit 1
elif [[ $WARN_COUNT -gt 0 ]]; then
    exit 0
else
    exit 0
fi
