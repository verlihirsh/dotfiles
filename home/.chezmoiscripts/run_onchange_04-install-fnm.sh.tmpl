{{- if (index . "installNode" | default false) -}}
#!/usr/bin/env bash
# chezmoi:template:left-delimiter="# {{" right-delimiter="}}"
#
# Install fnm and Node.js
# Runs when Node version changes
#
# Node version: # {{ .nodeVersion }}

set -euo pipefail

echo "==> Setting up Node.js via fnm..."

NODE_VERSION="# {{ .nodeVersion }}"

# Install fnm if not present
if ! command -v fnm &>/dev/null && [[ ! -d "$HOME/.local/share/fnm" ]]; then
    echo "Installing fnm..."
    curl -fsSL https://fnm.vercel.app/install | bash -s -- --skip-shell
fi

# Set up fnm for current session
export PATH="$HOME/.local/share/fnm:$PATH"
eval "$(fnm env)" 2>/dev/null || true

# Install Node.js version if not already installed
if ! fnm list 2>/dev/null | grep -q "v${NODE_VERSION}"; then
    echo "Installing Node.js $NODE_VERSION..."
    fnm install "$NODE_VERSION"
else
    echo "Node.js $NODE_VERSION already installed"
fi

# Set as default
echo "Setting Node.js $NODE_VERSION as default..."
fnm default "$NODE_VERSION"
fnm use "$NODE_VERSION" 2>/dev/null || true

# Verify installation
echo "Node.js version: $(node --version)"
echo "npm version: $(npm --version)"

echo "==> Node.js setup complete!"
{{- end }}
