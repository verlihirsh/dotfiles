#!/usr/bin/env bash
# chezmoi:template:left-delimiter="# {{" right-delimiter="}}"
# {{ if not (or (index . "installZsh" | default false) (index . "installPython" | default false) (index . "installNode" | default false) (index . "installNeovim" | default false) (index . "installCliTools" | default false)) }}
# Skip - no dependencies selected
exit 0
# {{ end }}
#
# Install system dependencies
# Runs when this file content changes (version bump = re-run)
#
# Version: 1.0.0

set -euo pipefail

echo "==> Installing system dependencies..."

# {{- if eq .chezmoi.os "darwin" }}

# macOS: Install Homebrew if not present
if ! command -v brew &>/dev/null; then
    echo "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    
    # Add to PATH for current session
    if [[ -f /opt/homebrew/bin/brew ]]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
    elif [[ -f /usr/local/bin/brew ]]; then
        eval "$(/usr/local/bin/brew shellenv)"
    fi
fi

echo "Updating Homebrew..."
brew update

# Install base packages
brew install git curl wget

# {{- if (index . "installZsh" | default false) }}
brew install zsh
# {{- end }}

# {{- if (index . "installPython" | default false) }}
# pyenv dependencies (macOS handles most via Xcode CLT)
brew install openssl readline sqlite3 xz zlib tcl-tk
# {{- end }}

# Neovim is now installed via run_onchange_05-00-install-neovim.sh.tmpl

# {{- else if eq .chezmoi.os "linux" }}

# Detect package manager
if command -v apt-get &>/dev/null; then
    PKG_MANAGER="apt"
elif command -v dnf &>/dev/null; then
    PKG_MANAGER="dnf"
elif command -v pacman &>/dev/null; then
    PKG_MANAGER="pacman"
else
    echo "Unsupported package manager"
    exit 1
fi

case "$PKG_MANAGER" in
    apt)
        echo "Updating apt cache..."
        sudo apt-get update -qq
        
        # Base packages
        sudo apt-get install -y -qq git curl wget ca-certificates gnupg
        
        # {{- if (index . "installZsh" | default false) }}
        sudo apt-get install -y -qq zsh
        # {{- end }}
        
        # {{- if (index . "installPython" | default false) }}
        # pyenv build dependencies
        sudo apt-get install -y -qq \
            build-essential \
            libssl-dev \
            zlib1g-dev \
            libbz2-dev \
            libreadline-dev \
            libsqlite3-dev \
            libncursesw5-dev \
            xz-utils \
            tk-dev \
            libxml2-dev \
            libxmlsec1-dev \
            libffi-dev \
            liblzma-dev
        # {{- end }}
        
        # {{- if (index . "installNode" | default false) }}
        sudo apt-get install -y -qq unzip
        # {{- end }}
        
        # Neovim is now installed via run_onchange_05-00-install-neovim.sh.tmpl
        ;;
        
    dnf)
        echo "Installing packages via dnf..."
        
        # Base packages
        sudo dnf install -y -q git curl wget ca-certificates
        
        # {{- if (index . "installZsh" | default false) }}
        sudo dnf install -y -q zsh
        # {{- end }}
        
        # {{- if (index . "installPython" | default false) }}
        # pyenv build dependencies
        sudo dnf install -y -q \
            gcc \
            make \
            openssl-devel \
            zlib-devel \
            bzip2-devel \
            readline-devel \
            sqlite-devel \
            libffi-devel \
            xz-devel \
            tk-devel
        # {{- end }}
        
        # {{- if (index . "installNode" | default false) }}
        sudo dnf install -y -q unzip
        # {{- end }}
        
        # Neovim is now installed via run_onchange_05-00-install-neovim.sh.tmpl
        ;;
        
    pacman)
        echo "Installing packages via pacman..."
        
        # Base packages
        sudo pacman -S --noconfirm --needed git curl wget ca-certificates
        
        # {{- if (index . "installZsh" | default false) }}
        sudo pacman -S --noconfirm --needed zsh
        # {{- end }}
        
        # {{- if (index . "installPython" | default false) }}
        # pyenv build dependencies
        sudo pacman -S --noconfirm --needed base-devel openssl zlib bzip2 readline sqlite ncurses xz tk libffi
        # {{- end }}
        
        # {{- if (index . "installNode" | default false) }}
        sudo pacman -S --noconfirm --needed unzip
        # {{- end }}
        
        # Neovim is now installed via run_onchange_05-00-install-neovim.sh.tmpl
        ;;
esac

# {{- end }}

echo "==> System dependencies installed!"
