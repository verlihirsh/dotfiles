{{- if or (and (hasKey . "installZsh") .installZsh) (and (hasKey . "installPython") .installPython) (and (hasKey . "installNode") .installNode) (and (hasKey . "installNeovim") .installNeovim) (and (hasKey . "installCliTools") .installCliTools) -}}
#!/usr/bin/env bash
# chezmoi:template:left-delimiter="# {{" right-delimiter="}}"
#
# Install system dependencies
# Runs when this file content changes (version bump = re-run)
#
# Version: 1.0.0

set -euo pipefail

echo "==> Installing system dependencies..."

# {{- if eq .chezmoi.os "darwin" }}

# macOS: Install Homebrew if not present
if ! command -v brew &>/dev/null; then
    echo "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    
    # Add to PATH for current session
    if [[ -f /opt/homebrew/bin/brew ]]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
    elif [[ -f /usr/local/bin/brew ]]; then
        eval "$(/usr/local/bin/brew shellenv)"
    fi
fi

echo "Updating Homebrew..."
brew update

# Install base packages
brew install git curl wget

# {{- if .installZsh }}
brew install zsh
# {{- end }}

# {{- if .installPython }}
# pyenv dependencies (macOS handles most via Xcode CLT)
brew install openssl readline sqlite3 xz zlib tcl-tk
# {{- end }}

# {{- if .installNeovim }}
brew install neovim
# {{- end }}

# {{- else if eq .chezmoi.os "linux" }}

# Detect package manager
if command -v apt-get &>/dev/null; then
    PKG_MANAGER="apt"
elif command -v dnf &>/dev/null; then
    PKG_MANAGER="dnf"
elif command -v pacman &>/dev/null; then
    PKG_MANAGER="pacman"
else
    echo "Unsupported package manager"
    exit 1
fi

case "$PKG_MANAGER" in
    apt)
        echo "Updating apt cache..."
        sudo apt-get update -qq
        
        # Base packages
        sudo apt-get install -y -qq git curl wget ca-certificates gnupg
        
        # {{- if .installZsh }}
        sudo apt-get install -y -qq zsh
        # {{- end }}
        
        # {{- if .installPython }}
        # pyenv build dependencies
        sudo apt-get install -y -qq \
            build-essential \
            libssl-dev \
            zlib1g-dev \
            libbz2-dev \
            libreadline-dev \
            libsqlite3-dev \
            libncursesw5-dev \
            xz-utils \
            tk-dev \
            libxml2-dev \
            libxmlsec1-dev \
            libffi-dev \
            liblzma-dev
        # {{- end }}
        
        # {{- if .installNode }}
        sudo apt-get install -y -qq unzip
        # {{- end }}
        
        # {{- if .installNeovim }}
        # Try to get latest Neovim
        if command -v add-apt-repository &>/dev/null; then
            sudo add-apt-repository -y ppa:neovim-ppa/unstable 2>/dev/null || true
            sudo apt-get update -qq
        fi
        sudo apt-get install -y -qq neovim || true
        # {{- end }}
        ;;
        
    dnf)
        echo "Installing packages via dnf..."
        
        # Base packages
        sudo dnf install -y -q git curl wget ca-certificates
        
        # {{- if .installZsh }}
        sudo dnf install -y -q zsh
        # {{- end }}
        
        # {{- if .installPython }}
        # pyenv build dependencies
        sudo dnf install -y -q \
            gcc \
            make \
            openssl-devel \
            zlib-devel \
            bzip2-devel \
            readline-devel \
            sqlite-devel \
            libffi-devel \
            xz-devel \
            tk-devel
        # {{- end }}
        
        # {{- if .installNode }}
        sudo dnf install -y -q unzip
        # {{- end }}
        
        # {{- if .installNeovim }}
        sudo dnf install -y -q neovim || true
        # {{- end }}
        ;;
        
    pacman)
        echo "Installing packages via pacman..."
        
        # Base packages
        sudo pacman -S --noconfirm --needed git curl wget ca-certificates
        
        # {{- if .installZsh }}
        sudo pacman -S --noconfirm --needed zsh
        # {{- end }}
        
        # {{- if .installPython }}
        # pyenv build dependencies
        sudo pacman -S --noconfirm --needed base-devel openssl zlib bzip2 readline sqlite ncurses xz tk libffi
        # {{- end }}
        
        # {{- if .installNode }}
        sudo pacman -S --noconfirm --needed unzip
        # {{- end }}
        
        # {{- if .installNeovim }}
        sudo pacman -S --noconfirm --needed neovim
        # {{- end }}
        ;;
esac

# {{- end }}

echo "==> System dependencies installed!"
{{- end }}
