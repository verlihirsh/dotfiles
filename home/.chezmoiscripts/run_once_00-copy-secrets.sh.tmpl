#!/bin/bash
# chezmoi:template:left-delimiter="# {{" right-delimiter="}}"
# {{ if not (index . "secretsPath" | default false) }}
# Skip - no secrets path configured
exit 0
# {{ end }}
# Copy secrets from source path to home directory (mirrored structure)
# Source: # {{ index . "secretsPath" | default "" }}

set -e

SECRETS_PATH="# {{ index . "secretsPath" | default "" }}"

# Expand ~ to home directory
SECRETS_PATH="${SECRETS_PATH/#\~/$HOME}"

if [[ ! -d "$SECRETS_PATH" ]]; then
    echo "‚ö†Ô∏è  Secrets path does not exist: $SECRETS_PATH"
    echo "   Skipping secrets copy."
    exit 0
fi

echo "üì¶ Copying secrets from: $SECRETS_PATH"

# Function to copy with proper permissions
copy_secret() {
    local src="$1"
    local dest="$2"
    local mode="${3:-600}"
    
    if [[ -e "$src" ]]; then
        mkdir -p "$(dirname "$dest")"
        
        # Check if destination exists
        if [[ -e "$dest" ]]; then
            echo "   ‚ö†Ô∏è  $(basename "$dest") already exists"
            
            # Compare files/directories
            if [[ -f "$src" ]] && [[ -f "$dest" ]]; then
                if diff -q "$src" "$dest" &>/dev/null; then
                    echo "   ‚úì $(basename "$src") (unchanged)"
                    return 0
                fi
            fi
            
            # Create backup
            local backup_path="${dest}.backup.$(date +%Y%m%d_%H%M%S)"
            echo "   Creating backup: $backup_path"
            cp -r "$dest" "$backup_path" 2>/dev/null || true
        fi
        
        # Copy the file/directory
        cp -r "$src" "$dest"
        
        # Set permissions (recursive for directories)
        if [[ -d "$dest" ]]; then
            find "$dest" -type f -exec chmod "$mode" {} \;
            find "$dest" -type d -exec chmod 700 {} \;
        else
            chmod "$mode" "$dest"
        fi
        echo "   ‚úì $(basename "$src")"
    fi
}

# SSH keys and config
if [[ -d "$SECRETS_PATH/.ssh" ]]; then
    echo "üîë SSH configuration..."
    
    # Copy all files from .ssh directory
    for item in "$SECRETS_PATH/.ssh"/*; do
        [[ -e "$item" ]] || continue
        name=$(basename "$item")
        
        # Public keys can be world-readable
        if [[ "$name" == *.pub ]]; then
            copy_secret "$item" "$HOME/.ssh/$name" 644
        else
            copy_secret "$item" "$HOME/.ssh/$name" 600
        fi
    done
fi

# GitHub CLI config
if [[ -d "$SECRETS_PATH/.config/gh" ]]; then
    echo "üêô GitHub CLI configuration..."
    copy_secret "$SECRETS_PATH/.config/gh" "$HOME/.config/gh" 600
fi

# .netrc (API tokens for various services)
if [[ -f "$SECRETS_PATH/.netrc" ]]; then
    echo "üîê .netrc..."
    copy_secret "$SECRETS_PATH/.netrc" "$HOME/.netrc" 600
fi

# AWS credentials
if [[ -d "$SECRETS_PATH/.aws" ]]; then
    echo "‚òÅÔ∏è  AWS configuration..."
    copy_secret "$SECRETS_PATH/.aws" "$HOME/.aws" 600
fi

# GPG keys
if [[ -d "$SECRETS_PATH/.gnupg" ]]; then
    echo "üîè GPG configuration..."
    copy_secret "$SECRETS_PATH/.gnupg" "$HOME/.gnupg" 600
fi

# Environment files
if [[ -f "$SECRETS_PATH/.env" ]]; then
    echo "üìã Environment file..."
    copy_secret "$SECRETS_PATH/.env" "$HOME/.env" 600
fi

# Copy any other files/directories that exist (generic mirroring)
# This catches anything not explicitly handled above
for item in "$SECRETS_PATH"/.*; do
    [[ -e "$item" ]] || continue
    name=$(basename "$item")
    
    # Skip . and .. and already-handled directories
    [[ "$name" == "." || "$name" == ".." ]] && continue
    [[ "$name" == ".ssh" || "$name" == ".config" || "$name" == ".aws" || "$name" == ".gnupg" ]] && continue
    [[ "$name" == ".netrc" || "$name" == ".env" ]] && continue
    
    # Skip if already exists in home
    [[ -e "$HOME/$name" ]] && continue
    
    echo "üìÑ $name..."
    copy_secret "$item" "$HOME/$name" 600
done

# Handle .config subdirectories (other than gh which is already handled)
if [[ -d "$SECRETS_PATH/.config" ]]; then
    for item in "$SECRETS_PATH/.config"/*; do
        [[ -e "$item" ]] || continue
        name=$(basename "$item")
        [[ "$name" == "gh" ]] && continue  # Already handled
        
        echo "‚öôÔ∏è  .config/$name..."
        copy_secret "$item" "$HOME/.config/$name" 600
    done
fi

echo ""
echo "‚úÖ Secrets copied successfully!"
