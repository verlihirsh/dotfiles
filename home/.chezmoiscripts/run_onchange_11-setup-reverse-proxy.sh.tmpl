#!/usr/bin/env bash
# chezmoi:template:left-delimiter="# {{" right-delimiter="}}"
# {{ if not (index . "setupReverseProxy" | default false) }}
exit 0
# {{ end }}
#
# Setup SSH reverse proxy tunnel
#
# Version: 1.0.0

set -euo pipefail

echo "==> Setting up reverse proxy"

# {{ $vpsHost := promptStringOnce . "vpsHost" "VPS hostname (e.g., vps.example.com)" }}
# {{ $vpsUser := promptStringOnce . "vpsUser" "VPS username (e.g., user_on_vps)" }}
# {{ $remotePort := promptStringOnce . "reverseProxyRemotePort" "Remote port on VPS (default: 2222)" | default "2222" }}
# {{ $localPort := promptStringOnce . "reverseProxyLocalPort" "Local SSH port (default: 22)" | default "22" }}

VPS_HOST="# {{ $vpsHost }}"
VPS_USER="# {{ $vpsUser }}"
REMOTE_PORT="# {{ $remotePort }}"
LOCAL_PORT="# {{ $localPort }}"

if [ -z "$VPS_HOST" ] || [ -z "$VPS_USER" ]; then
    echo "❌ VPS host or user not configured"
    exit 1
fi

# Create systemd service file (Linux) or launchd plist (macOS)
# {{- if eq .chezmoi.os "darwin" }}

# macOS: Create launchd service
PLIST_PATH="$HOME/Library/LaunchAgents/com.user.ssh-reverse-proxy.plist"
mkdir -p "$HOME/Library/LaunchAgents"

cat > "$PLIST_PATH" <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.user.ssh-reverse-proxy</string>
    <key>ProgramArguments</key>
    <array>
        <string>/usr/bin/ssh</string>
        <string>-N</string>
        <string>-T</string>
        <string>-o</string>
        <string>ServerAliveInterval=30</string>
        <string>-o</string>
        <string>ServerAliveCountMax=3</string>
        <string>-o</string>
        <string>ExitOnForwardFailure=yes</string>
        <string>-R</string>
        <string>127.0.0.1:${REMOTE_PORT}:localhost:${LOCAL_PORT}</string>
        <string>${VPS_USER}@${VPS_HOST}</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <dict>
        <key>SuccessfulExit</key>
        <false/>
    </dict>
    <key>StandardOutPath</key>
    <string>$HOME/Library/Logs/ssh-reverse-proxy.log</string>
    <key>StandardErrorPath</key>
    <string>$HOME/Library/Logs/ssh-reverse-proxy.err</string>
</dict>
</plist>
EOF

# Load the service
launchctl unload "$PLIST_PATH" 2>/dev/null || true
launchctl load "$PLIST_PATH"

echo "✅ SSH reverse proxy service installed (launchd)"
echo "   Service: $PLIST_PATH"
echo "   Target: ${VPS_USER}@${VPS_HOST}"
echo "   Tunnel: 127.0.0.1:${REMOTE_PORT} -> localhost:${LOCAL_PORT}"
echo ""
echo "Commands:"
echo "  Start:  launchctl load $PLIST_PATH"
echo "  Stop:   launchctl unload $PLIST_PATH"
echo "  Status: launchctl list | grep ssh-reverse-proxy"
echo "  Logs:   tail -f ~/Library/Logs/ssh-reverse-proxy.{log,err}"

# {{- else if eq .chezmoi.os "linux" }}

# Linux: Create systemd service
SERVICE_FILE="$HOME/.config/systemd/user/ssh-reverse-proxy.service"
mkdir -p "$HOME/.config/systemd/user"

cat > "$SERVICE_FILE" <<EOF
[Unit]
Description=SSH Reverse Proxy Tunnel
After=network.target

[Service]
Type=simple
ExecStart=/usr/bin/ssh -N -T \\
    -o ServerAliveInterval=30 \\
    -o ServerAliveCountMax=3 \\
    -o ExitOnForwardFailure=yes \\
    -R 127.0.0.1:${REMOTE_PORT}:localhost:${LOCAL_PORT} \\
    ${VPS_USER}@${VPS_HOST}
Restart=always
RestartSec=10

[Install]
WantedBy=default.target
EOF

# Reload systemd and enable the service
systemctl --user daemon-reload
systemctl --user enable ssh-reverse-proxy.service
systemctl --user start ssh-reverse-proxy.service

echo "✅ SSH reverse proxy service installed (systemd)"
echo "   Service: $SERVICE_FILE"
echo "   Target: ${VPS_USER}@${VPS_HOST}"
echo "   Tunnel: 127.0.0.1:${REMOTE_PORT} -> localhost:${LOCAL_PORT}"
echo ""
echo "Commands:"
echo "  Start:  systemctl --user start ssh-reverse-proxy"
echo "  Stop:   systemctl --user stop ssh-reverse-proxy"
echo "  Status: systemctl --user status ssh-reverse-proxy"
echo "  Logs:   journalctl --user -u ssh-reverse-proxy -f"

# {{- end }}

echo ""
echo "⚠️  Make sure you have:"
echo "  1. SSH key authentication set up for ${VPS_USER}@${VPS_HOST}"
echo "  2. GatewayPorts clientspecified (or no) in VPS sshd_config"
echo "  3. Firewall rules allowing the tunnel if needed"
