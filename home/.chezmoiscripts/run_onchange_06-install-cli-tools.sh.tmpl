#!/usr/bin/env bash
# chezmoi:template:left-delimiter="# {{" right-delimiter="}}"
# {{ if not (index . "installCliTools" | default false) }}
# Skip - CLI tools not enabled
exit 0
# {{ end }}
#
# Install CLI tools (fzf, ripgrep, fd, bat, etc.)
#
# Version: 1.0.0

set -euo pipefail

echo "==> Installing CLI tools..."

# {{- if eq .chezmoi.os "darwin" }}

# macOS: Use Homebrew
if command -v brew &>/dev/null; then
    echo "Installing CLI tools via Homebrew..."
    brew install fzf ripgrep fd bat eza jq htop tree uv || true
    
    # Install fzf key bindings and completion
    "$(brew --prefix)/opt/fzf/install" --key-bindings --completion --no-update-rc --no-bash --no-fish 2>/dev/null || true
else
    echo "Homebrew not found, skipping CLI tools"
fi

# {{- else if eq .chezmoi.os "linux" }}

# Detect package manager
if command -v apt-get &>/dev/null; then
    PKG_MANAGER="apt"
elif command -v dnf &>/dev/null; then
    PKG_MANAGER="dnf"
elif command -v pacman &>/dev/null; then
    PKG_MANAGER="pacman"
else
    echo "Unsupported package manager"
    exit 0
fi

case "$PKG_MANAGER" in
    apt)
        echo "Installing CLI tools via apt..."
        sudo apt-get update -qq
        sudo apt-get install -y -qq fzf ripgrep fd-find bat jq htop tree curl wget || true
        
        # Install uv
        if ! command -v uv &>/dev/null; then
            echo "Installing uv..."
            curl -LsSf https://astral.sh/uv/install.sh | sh
        fi
        
        # Create symlinks for fd and bat (Debian/Ubuntu use different names)
        mkdir -p "$HOME/.local/bin"
        if command -v fdfind &>/dev/null && [[ ! -L "$HOME/.local/bin/fd" ]]; then
            ln -sf "$(which fdfind)" "$HOME/.local/bin/fd"
        fi
        if command -v batcat &>/dev/null && [[ ! -L "$HOME/.local/bin/bat" ]]; then
            ln -sf "$(which batcat)" "$HOME/.local/bin/bat"
        fi
        
        # Install eza from GitHub (not in standard repos)
        if ! command -v eza &>/dev/null; then
            echo "Installing eza from GitHub..."
            EZA_VERSION=$(curl -s "https://api.github.com/repos/eza-community/eza/releases/latest" | grep -Po '"tag_name": "v\K[^"]*' || echo "0.18.0")
            curl -fsSL "https://github.com/eza-community/eza/releases/download/v${EZA_VERSION}/eza_x86_64-unknown-linux-gnu.tar.gz" | tar -xz -C "$HOME/.local/bin" 2>/dev/null || true
        fi
        ;;
        
    dnf)
        echo "Installing CLI tools via dnf..."
        sudo dnf install -y -q fzf ripgrep fd-find bat jq htop tree || true
        
        # Install uv
        if ! command -v uv &>/dev/null; then
            echo "Installing uv..."
            curl -LsSf https://astral.sh/uv/install.sh | sh
        fi
        
        # eza may not be in standard repos
        if ! command -v eza &>/dev/null; then
            echo "Installing eza from GitHub..."
            EZA_VERSION=$(curl -s "https://api.github.com/repos/eza-community/eza/releases/latest" | grep -Po '"tag_name": "v\K[^"]*' || echo "0.18.0")
            mkdir -p "$HOME/.local/bin"
            curl -fsSL "https://github.com/eza-community/eza/releases/download/v${EZA_VERSION}/eza_x86_64-unknown-linux-gnu.tar.gz" | tar -xz -C "$HOME/.local/bin" 2>/dev/null || true
        fi
        ;;
        
    pacman)
        echo "Installing CLI tools via pacman..."
        sudo pacman -S --noconfirm --needed fzf ripgrep fd bat eza jq htop tree uv || true
        ;;
esac

# Install fzf key bindings if not present
if [[ -f /usr/share/doc/fzf/examples/key-bindings.zsh ]]; then
    echo "fzf key bindings available at /usr/share/doc/fzf/examples/"
fi

# {{- end }}

# Verify installations
echo ""
echo "Installed tools:"
command -v fzf &>/dev/null && echo "  - fzf: $(fzf --version 2>/dev/null | head -1)"
command -v rg &>/dev/null && echo "  - ripgrep: $(rg --version 2>/dev/null | head -1)"
command -v fd &>/dev/null && echo "  - fd: $(fd --version 2>/dev/null)"
command -v bat &>/dev/null && echo "  - bat: $(bat --version 2>/dev/null)"
command -v eza &>/dev/null && echo "  - eza: $(eza --version 2>/dev/null | head -1)"
command -v jq &>/dev/null && echo "  - jq: $(jq --version 2>/dev/null)"
command -v uv &>/dev/null && echo "  - uv: $(uv --version 2>/dev/null)"

echo "==> CLI tools installed!"
