#!/usr/bin/env bash
# chezmoi:template:left-delimiter="# {{" right-delimiter="}}"
# {{ if not (index . "installPython" | default false) }}
# Skip - Python not enabled
exit 0
# {{ end }}
#
# Install uv and Python
# Runs when Python version changes
#
# Python version: # {{ index . "pythonVersion" | default "3.12" }}

set -euo pipefail

echo "==> Setting up Python via uv..."

PYTHON_VERSION="# {{ index . "pythonVersion" | default "3.12" }}"

# Install uv if not present
if ! command -v uv &>/dev/null; then
    echo "Installing uv..."
    curl -LsSf https://astral.sh/uv/install.sh | sh
    
    # Add to PATH for current session
    export PATH="$HOME/.local/bin:$PATH"
else
    echo "uv already installed"
fi

# Ensure uv is up to date
echo "Updating uv to latest version..."
uv self update

# Parse Python versions from config (supports space or comma separated)
# Examples: "3.11 3.12 3.13" or "3.11, 3.12, 3.13" or just "3.12"
IFS=', ' read -ra VERSIONS <<< "$PYTHON_VERSION"

# Install Python versions
for version in "${VERSIONS[@]}"; do
    # Trim whitespace
    version=$(echo "$version" | xargs)
    
    if [[ -n "$version" ]]; then
        echo "Installing Python $version..."
        uv python install "$version" || echo "Python $version already installed or not available"
    fi
done

# Set the first version as default if a .python-version file doesn't exist in home
if [[ ! -f "$HOME/.python-version" ]] && [[ ${#VERSIONS[@]} -gt 0 ]]; then
    first_version=$(echo "${VERSIONS[0]}" | xargs)
    echo "Setting Python $first_version as default..."
    cd "$HOME" && uv python pin "$first_version"
fi

# Verify installation
echo "Installed Python versions:"
uv python list

# Find the default Python
if [[ -f "$HOME/.python-version" ]]; then
    default_version=$(cat "$HOME/.python-version")
    python_path=$(uv python find "$default_version" 2>/dev/null || echo "not found")
    echo "Default Python version: $default_version"
    echo "Python path: $python_path"
    
    # Verify it works
    if [[ "$python_path" != "not found" ]]; then
        echo "Python version: $("$python_path" --version 2>&1)"
    fi
fi

echo "==> Python setup complete!"
