#!/usr/bin/env bash
# chezmoi:template:left-delimiter="# {{" right-delimiter="}}"
# {{ if not (index . "installPython" | default false) }}
# Skip - Python not enabled
exit 0
# {{ end }}
#
# Install pyenv and Python
# Runs when Python version changes
#
# Python version: # {{ index . "pythonVersion" | default "3.12" }}

set -euo pipefail

echo "==> Setting up Python via pyenv..."

PYTHON_VERSION="# {{ index . "pythonVersion" | default "3.12" }}"
# LLM:TODO why do we use pyenv here? Is it nessesary? I'd prefer to have uv instead.
# LLM:RESP: You're right - uv is a better choice for modern Python management (2025+). Here's why:
# LLM:RESP: 
# LLM:RESP: **pyenv vs uv comparison:**
# LLM:RESP: - uv is 10-100x faster (Rust-based), replaces pip/poetry/pyenv/pipx in one tool
# LLM:RESP: - NO shell hooks needed (pyenv requires `eval "$(pyenv init -)"`)
# LLM:RESP: - Auto-downloads Python versions on-demand: `uv python install 3.12`
# LLM:RESP: - Self-updating: `uv self update`
# LLM:RESP: - Respects `.python-version` files (same as pyenv)
# LLM:RESP: 
# LLM:RESP: **To migrate to uv:**
# LLM:RESP: 1. Replace this script with run_onchange_03-install-uv.sh.tmpl
# LLM:RESP: 2. Remove pyenv shell init from .zshrc/.bashrc (eval lines)
# LLM:RESP: 3. Install uv: `curl -LsSf https://astral.sh/uv/install.sh | sh`
# LLM:RESP: 4. Add to PATH: `export PATH="$HOME/.local/bin:$PATH"`
# LLM:RESP: 5. Install Python: `uv python install 3.11 3.12 3.13`
# LLM:RESP: 
# LLM:RESP: **Keep pyenv only if you need:**
# LLM:RESP: - Custom Python builds with specific compile flags
# LLM:RESP: - Heavy pyenv plugin usage (pyenv-virtualenv, etc.)
# LLM:RESP: 
# LLM:RESP: For standard Python version management, uv is simpler, faster, and more future-proof. 

# Install pyenv if not present
if [[ ! -d "$HOME/.pyenv" ]]; then
    echo "Installing pyenv..."
    curl -fsSL https://pyenv.run | bash
fi

# Set up pyenv for current session
export PYENV_ROOT="$HOME/.pyenv"
export PATH="$PYENV_ROOT/bin:$PATH"
eval "$(pyenv init --path)" 2>/dev/null || true
eval "$(pyenv init -)" 2>/dev/null || true

# Install Python version if not already installed
if ! pyenv versions --bare 2>/dev/null | grep -q "^${PYTHON_VERSION}"; then
    echo "Installing Python $PYTHON_VERSION (this may take several minutes)..."
    pyenv install "$PYTHON_VERSION"
else
    echo "Python $PYTHON_VERSION already installed"
fi

# Set as global default
echo "Setting Python $PYTHON_VERSION as global default..."
pyenv global "$PYTHON_VERSION"

# Verify installation
echo "Python version: $(pyenv exec python --version)"
echo "pip version: $(pyenv exec pip --version)"

echo "==> Python setup complete!"
