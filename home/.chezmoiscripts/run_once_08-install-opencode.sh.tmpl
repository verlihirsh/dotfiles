#!/usr/bin/env bash
# chezmoi:template:left-delimiter="# {{" right-delimiter="}}"
# {{ if not (index . "installOpencode" | default false) }}
# Skip - OpenCode not enabled
exit 0
# {{ end }}
#
# Install OpenCode and oh-my-opencode
#
# Subscriptions: claude=# {{ if (index . "opencodeClaudeMax" | default false) }}max20# {{ else if (index . "opencodeClaude" | default false) }}yes# {{ else }}no# {{ end }}, chatgpt=# {{ if (index . "opencodeChatgpt" | default false) }}yes# {{ else }}no# {{ end }}, gemini=# {{ if (index . "opencodeGemini" | default false) }}yes# {{ else }}no# {{ end }}
#
# Version: 1.0.5

set -euo pipefail

echo "==> Installing OpenCode..."

# Install OpenCode via official installer
curl -fsSL https://opencode.ai/install | bash

# Add to PATH for current session
export PATH="$HOME/.opencode/bin:$PATH"

# Verify OpenCode installation
if ! command -v opencode &>/dev/null; then
    echo "⚠️  OpenCode installation failed"
    exit 1
fi
echo "✅ OpenCode installed: $(opencode --version 2>/dev/null || echo 'unknown')"

echo ""
echo "==> Installing bun (required for oh-my-opencode)..."

# Install bun if not present
if ! command -v bun &>/dev/null; then
    curl -fsSL https://bun.sh/install | bash
fi
export PATH="$HOME/.bun/bin:$PATH"

echo ""
echo "==> Installing oh-my-opencode..."

# Build subscription flags from chezmoi config
# {{ if (index . "opencodeClaudeMax" | default false) }}
CLAUDE_FLAG="--claude=max20"
# {{ else if (index . "opencodeClaude" | default false) }}
CLAUDE_FLAG="--claude=yes"
# {{ else }}
CLAUDE_FLAG="--claude=no"
# {{ end }}

# {{ if (index . "opencodeChatgpt" | default false) }}
CHATGPT_FLAG="--chatgpt=yes"
# {{ else }}
CHATGPT_FLAG="--chatgpt=no"
# {{ end }}

# {{ if (index . "opencodeGemini" | default false) }}
GEMINI_FLAG="--gemini=yes"
# {{ else }}
GEMINI_FLAG="--gemini=no"
# {{ end }}

# Run oh-my-opencode installer with subscription flags
bunx oh-my-opencode install --no-tui $CLAUDE_FLAG $CHATGPT_FLAG $GEMINI_FLAG || \
    npx oh-my-opencode install --no-tui $CLAUDE_FLAG $CHATGPT_FLAG $GEMINI_FLAG || \
    echo "⚠️  oh-my-opencode install failed"

echo ""
echo "✅ OpenCode + oh-my-opencode installed!"
echo ""
echo "To authenticate, run: opencode auth login"
