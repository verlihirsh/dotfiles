{{- if and (hasKey . "installPython") .installPython -}}
#!/usr/bin/env bash
# chezmoi:template:left-delimiter="# {{" right-delimiter="}}"
#
# Install pyenv and Python
# Runs when Python version changes
#
# Python version: # {{ .pythonVersion }}

set -euo pipefail

echo "==> Setting up Python via pyenv..."

PYTHON_VERSION="# {{ .pythonVersion }}"

# Install pyenv if not present
if [[ ! -d "$HOME/.pyenv" ]]; then
    echo "Installing pyenv..."
    curl -fsSL https://pyenv.run | bash
fi

# Set up pyenv for current session
export PYENV_ROOT="$HOME/.pyenv"
export PATH="$PYENV_ROOT/bin:$PATH"
eval "$(pyenv init --path)" 2>/dev/null || true
eval "$(pyenv init -)" 2>/dev/null || true

# Install Python version if not already installed
if ! pyenv versions --bare 2>/dev/null | grep -q "^${PYTHON_VERSION}"; then
    echo "Installing Python $PYTHON_VERSION (this may take several minutes)..."
    pyenv install "$PYTHON_VERSION"
else
    echo "Python $PYTHON_VERSION already installed"
fi

# Set as global default
echo "Setting Python $PYTHON_VERSION as global default..."
pyenv global "$PYTHON_VERSION"

# Verify installation
echo "Python version: $(pyenv exec python --version)"
echo "pip version: $(pyenv exec pip --version)"

echo "==> Python setup complete!"
{{- end }}
