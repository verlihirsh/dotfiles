#!/usr/bin/env bash
# chezmoi:template:left-delimiter="# {{" right-delimiter="}}"
# {{ if not (index . "installNeovim" | default false) }}
# Skip - Neovim not enabled
exit 0
# {{ end }}
#
# Post-install setup for Neovim
# Neovim is installed via system deps script
# jelvim config is installed via .chezmoiscripts/run_onchange_05-01-install-jelvim.sh
#
# Version: 1.1.0 - Added LSP extras integration
# Hash: # {{ include "dot_config/nvim-lsp-extras/lsp-extras.lua.tmpl" | sha256sum }}

set -euo pipefail

echo "==> Configuring Neovim..."

# Ensure nvim is available
if ! command -v nvim &>/dev/null; then
    echo "Neovim not found in PATH. It should be installed via system dependencies."
    echo "Skipping Neovim configuration."
    exit 0
fi

# Create necessary directories
mkdir -p "$HOME/.local/share/nvim"
mkdir -p "$HOME/.cache/nvim"

# jelvim config is installed via script to ~/.config/nvim (ignored by chezmoi)

echo "Neovim version: $(nvim --version | head -1)"
echo "Config location: ~/.config/nvim (jelvim)"

# Install LSP extras plugin (extends jelvim with additional LSP servers)
# {{ if (index . "installLspServers" | default false) }}
LSP_EXTRAS_SRC="$HOME/.config/nvim-lsp-extras/lsp-extras.lua"
LSP_EXTRAS_DST="$HOME/.config/nvim/lua/plugins/lsp-extras.lua"

if [[ -f "$LSP_EXTRAS_SRC" ]]; then
    # Ensure plugins directory exists
    mkdir -p "$HOME/.config/nvim/lua/plugins"
    
    # Check if destination exists and differs
    if [[ -f "$LSP_EXTRAS_DST" ]]; then
        if ! diff -q "$LSP_EXTRAS_SRC" "$LSP_EXTRAS_DST" &>/dev/null; then
            echo "LSP extras file differs from source. Creating backup..."
            cp "$LSP_EXTRAS_DST" "${LSP_EXTRAS_DST}.backup.$(date +%Y%m%d_%H%M%S)"
            echo "Backup created: ${LSP_EXTRAS_DST}.backup.$(date +%Y%m%d_%H%M%S)"
        else
            echo "LSP extras already up to date"
        fi
    fi
    
    # Copy LSP extras (not symlink - keeps jelvim git clean)
    cp "$LSP_EXTRAS_SRC" "$LSP_EXTRAS_DST"
    echo "Installed LSP extras plugin: $LSP_EXTRAS_DST"
else
    echo "Warning: LSP extras source not found at $LSP_EXTRAS_SRC"
fi
# {{ else }}
echo "LSP servers not enabled, skipping LSP extras plugin"
# {{ end }}

# Run plugin installation on first launch (headless)
if [[ -f "$HOME/.config/nvim/init.lua" ]]; then
    echo "Running initial plugin sync (this may take a moment)..."
    # Try lazy.nvim sync if using lazy
    nvim --headless "+Lazy! sync" +qa 2>/dev/null || true
fi

echo "==> Neovim configured!"
