#!/usr/bin/env bash
# chezmoi:template:left-delimiter="# {{" right-delimiter="}}"
# {{ if not (index . "installZsh" | default false) }}
# Skip - zsh not enabled
exit 0
# {{ end }}
#
# Install oh-my-zsh and selected plugins (not managed by chezmoi)
#
# Version: 1.0.0

set -euo pipefail

echo "==> Installing oh-my-zsh and plugins..."

if ! command -v git &>/dev/null; then
  echo "git not found; cannot install oh-my-zsh"
  exit 1
fi

ZSH_DIR="$HOME/.oh-my-zsh"
ZSH_CUSTOM="${ZSH_CUSTOM:-$ZSH_DIR/custom}"

if [[ ! -d "$ZSH_DIR" ]]; then
  echo "Cloning oh-my-zsh into $ZSH_DIR..."
  git clone --depth 1 https://github.com/ohmyzsh/ohmyzsh.git "$ZSH_DIR"
else
  echo "Updating oh-my-zsh in $ZSH_DIR..."
  git -C "$ZSH_DIR" pull --ff-only || true
fi

mkdir -p "$ZSH_CUSTOM/plugins"

clone_or_update_plugin() {
  local name="$1"
  local url="$2"
  local dir="$ZSH_CUSTOM/plugins/$name"

  if [[ ! -d "$dir/.git" ]]; then
    echo "Cloning $name..."
    rm -rf "$dir" 2>/dev/null || true
    git clone --depth 1 "$url" "$dir"
  else
    echo "Updating $name..."
    git -C "$dir" pull --ff-only || true
  fi
}

clone_or_update_plugin "zsh-autosuggestions" "https://github.com/zsh-users/zsh-autosuggestions.git"
clone_or_update_plugin "zsh-syntax-highlighting" "https://github.com/zsh-users/zsh-syntax-highlighting.git"
clone_or_update_plugin "zsh-completions" "https://github.com/zsh-users/zsh-completions.git"
clone_or_update_plugin "zsh-history-substring-search" "https://github.com/zsh-users/zsh-history-substring-search.git"
clone_or_update_plugin "fzf-tab" "https://github.com/Aloxaf/fzf-tab.git"
clone_or_update_plugin "fzf-tab-source" "https://github.com/Freed-Wu/fzf-tab-source.git"

# Ensure cache dir exists (ignored by chezmoi)
mkdir -p "$ZSH_DIR/cache"

echo "==> oh-my-zsh installation complete!"
